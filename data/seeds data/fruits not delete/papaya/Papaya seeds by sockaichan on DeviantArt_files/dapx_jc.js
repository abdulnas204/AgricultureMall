/*
 *  (c) 2000-2015 deviantART, Inc. All rights reserved.
 */
(function(n){function r(n,r){var t=n[0],c=n[1],f=n[2],a=n[3];t=o(t,c,f,a,r[0],7,-680876936),a=o(a,t,c,f,r[1],12,-389564586),f=o(f,a,t,c,r[2],17,606105819),c=o(c,f,a,t,r[3],22,-1044525330),t=o(t,c,f,a,r[4],7,-176418897),a=o(a,t,c,f,r[5],12,1200080426),f=o(f,a,t,c,r[6],17,-1473231341),c=o(c,f,a,t,r[7],22,-45705983),t=o(t,c,f,a,r[8],7,1770035416),a=o(a,t,c,f,r[9],12,-1958414417),f=o(f,a,t,c,r[10],17,-42063),c=o(c,f,a,t,r[11],22,-1990404162),t=o(t,c,f,a,r[12],7,1804603682),a=o(a,t,c,f,r[13],12,-40341101),f=o(f,a,t,c,r[14],17,-1502002290),c=o(c,f,a,t,r[15],22,1236535329),t=u(t,c,f,a,r[1],5,-165796510),a=u(a,t,c,f,r[6],9,-1069501632),f=u(f,a,t,c,r[11],14,643717713),c=u(c,f,a,t,r[0],20,-373897302),t=u(t,c,f,a,r[5],5,-701558691),a=u(a,t,c,f,r[10],9,38016083),f=u(f,a,t,c,r[15],14,-660478335),c=u(c,f,a,t,r[4],20,-405537848),t=u(t,c,f,a,r[9],5,568446438),a=u(a,t,c,f,r[14],9,-1019803690),f=u(f,a,t,c,r[3],14,-187363961),c=u(c,f,a,t,r[8],20,1163531501),t=u(t,c,f,a,r[13],5,-1444681467),a=u(a,t,c,f,r[2],9,-51403784),f=u(f,a,t,c,r[7],14,1735328473),c=u(c,f,a,t,r[12],20,-1926607734),t=i(t,c,f,a,r[5],4,-378558),a=i(a,t,c,f,r[8],11,-2022574463),f=i(f,a,t,c,r[11],16,1839030562),c=i(c,f,a,t,r[14],23,-35309556),t=i(t,c,f,a,r[1],4,-1530992060),a=i(a,t,c,f,r[4],11,1272893353),f=i(f,a,t,c,r[7],16,-155497632),c=i(c,f,a,t,r[10],23,-1094730640),t=i(t,c,f,a,r[13],4,681279174),a=i(a,t,c,f,r[0],11,-358537222),f=i(f,a,t,c,r[3],16,-722521979),c=i(c,f,a,t,r[6],23,76029189),t=i(t,c,f,a,r[9],4,-640364487),a=i(a,t,c,f,r[12],11,-421815835),f=i(f,a,t,c,r[15],16,530742520),c=i(c,f,a,t,r[2],23,-995338651),t=e(t,c,f,a,r[0],6,-198630844),a=e(a,t,c,f,r[7],10,1126891415),f=e(f,a,t,c,r[14],15,-1416354905),c=e(c,f,a,t,r[5],21,-57434055),t=e(t,c,f,a,r[12],6,1700485571),a=e(a,t,c,f,r[3],10,-1894986606),f=e(f,a,t,c,r[10],15,-1051523),c=e(c,f,a,t,r[1],21,-2054922799),t=e(t,c,f,a,r[8],6,1873313359),a=e(a,t,c,f,r[15],10,-30611744),f=e(f,a,t,c,r[6],15,-1560198380),c=e(c,f,a,t,r[13],21,1309151649),t=e(t,c,f,a,r[4],6,-145523070),a=e(a,t,c,f,r[11],10,-1120210379),f=e(f,a,t,c,r[2],15,718787259),c=e(c,f,a,t,r[9],21,-343485551),n[0]=l(t,n[0]),n[1]=l(c,n[1]),n[2]=l(f,n[2]),n[3]=l(a,n[3])}function t(n,r,t,o,u,i){return r=l(l(r,n),l(o,i)),l(r<<u|r>>>32-u,t)}function o(n,r,o,u,i,e,c){return t(r&o|~r&u,n,r,i,e,c)}function u(n,r,o,u,i,e,c){return t(r&u|o&~u,n,r,i,e,c)}function i(n,r,o,u,i,e,c){return t(r^o^u,n,r,i,e,c)}function e(n,r,o,u,i,e,c){return t(o^(r|~u),n,r,i,e,c)}function c(n){txt="";var t,o=n.length,u=[1732584193,-271733879,-1732584194,271733878];for(t=64;n.length>=t;t+=64)r(u,f(n.substring(t-64,t)));n=n.substring(t-64);var i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;n.length>t;t++)i[t>>2]|=n.charCodeAt(t)<<(t%4<<3);if(i[t>>2]|=128<<(t%4<<3),t>55)for(r(u,i),t=0;16>t;t++)i[t]=0;return i[14]=8*o,r(u,i),u}function f(n){var r,t=[];for(r=0;64>r;r+=4)t[r>>2]=n.charCodeAt(r)+(n.charCodeAt(r+1)<<8)+(n.charCodeAt(r+2)<<16)+(n.charCodeAt(r+3)<<24);return t}function a(n){for(var r="",t=0;4>t;t++)r+=v[15&n>>8*t+4]+v[15&n>>8*t];return r}function d(n){for(var r=0;n.length>r;r++)n[r]=a(n[r]);return n.join("")}function h(n){return d(c(n))}function l(n,r){return 4294967295&n+r}function l(n,r){var t=(65535&n)+(65535&r),o=(n>>16)+(r>>16)+(t>>16);return o<<16|65535&t}var v="0123456789abcdef".split("");"5d41402abc4b2a76b9719d911017c592"!=h("hello"),n.MD5=h})(window),window.DWait&&DWait.run("jms/thirdparty/lib/md5.js");
(function(){var e=/[^a-zA-Z0-9_]/g,t=3,i=function(){this.beacon_url=window.isVM?"//st.deviantart.lan:8081/dapx.gif?":"//dapxl.com/dapx.gif?",this.reserved_regex=/^(u|l|t|i|m|e|r|h|et|ej|ts|p|s|xy)$/,this.flush_pool=15,this.events_pool=20,this.reset()};i.prototype={reset:function(){this.ids={},this.queue=[]},init:function(){if(this.visible()){for(var e=window.dapx&&window.dapx.q||[],t=0;e.length>t;t++)this.command.apply(this,e[t]);var i=this;window.dapx=function(){i.command.apply(i,arguments)}}},visible:function(){var e,t,i=["webkit","moz","ms","o"];if("visibilityState"in document)e="visibilityState",t="visibilitychange";else for(var s=0;i.length>s;s++)if(i[s]+"VisibilityState"in document){e=i[s]+"VisibilityState",t=i[s]+"visibilitychange";break}if(!e||!t)return!0;if(!this.visibility_listener){var n=this;this.visibility_listener=function(){n.init()}}return document.removeEventListener(t,this.visibility_listener),"prerender"==document[e]||"unloaded"==document[e]?(document.addEventListener(t,this.visibility_listener),!1):!0},command:function(e,t){this.handlers[e]?this.handlers[e].call(this,t):this.log("unrecognized command "+e,t,"error")},handlers:{enable_debug:function(){this.debug_enabled=!0},disable_debug:function(){this.debug_enabled=!1},send:function(e){if(!e.instanceid||!e.logid||!e.type)return this.log("missing required property of daid, instanceid, or type. aborting.",e,"error"),void 0;e=this.sanitize(e),e.ts=(new Date).getTime(),e.v=t,document.hasOwnProperty("hidden")&&document.hidden&&(e.dh=1);var i={url:"u",logid:"l",type:"t",instanceid:"i",appmechanic:"m",event:"e",referrer:"r",href:"h",target:"et",jsnrr:"ej",sessionid:"s",screen_coordinates:"xy",pageviewid:"p"};for(var s in i)i.hasOwnProperty(s)&&e.hasOwnProperty(s)&&(e[i[s]]=e[s],delete e[s]);var n=e.i+"-"+e.l;if(this.ids[n])return this.log("deduping",e,"error"),void 0;if(this.ids[n]=1,this.log("queuing log",e),this.queue.push(e),!e.t.match(/..ad$/)){var o=!1;for(var a in e)switch(a){case"slot":case"ad_campaignid":case"adfw":case"adts":o=!0}o&&ddt.alert("dapx","Got invalid payload - ad keys in non ads",e,["dapx"],!0)}var r=(this.beacon_url+this.generate_query_string(this.queue)+"&x=1234").length;if(navigator.userAgent.match(/MSIE/)&&r>1500)this.flush("IE query string limit ("+r+")");else if(10==this.queue.length)this.flush("queue reached 10");else if(!this.timer){var h=this;this.timer=setTimeout(function(){h.flush("timer")},1e3)}},manual_flush:function(){this.flush("manual queue flush")}},flush:function(e){if(this.debug("flush: "+e),clearTimeout(this.timer),this.timer=!1,this.last_flush_ts){var t=Math.round((new Date).getTime()/1e3);this.events_pool=Math.min(20,this.events_pool+2*(t-this.last_flush_ts)),this.flush_pool=Math.min(15,this.flush_pool+(t-this.last_flush_ts)*(1/30)),this.debug("- seconds since last flush",t-this.last_flush_ts),this.debug("- events pool credit",2*(t-this.last_flush_ts)),this.debug("- flush pool credit",(t-this.last_flush_ts)*(1/30)),this.debug("- events pool before flush",this.events_pool),this.debug("- flush pool before flush",this.flush_pool)}if(this.queue.length>this.events_pool&&(this.log(this.queue.length-this.events_pool+" events ignored out of "+this.queue.length,this.events_pool,"warn"),this.queue=this.queue.slice(this.queue.length-this.events_pool,this.queue.length),0==this.queue.length))return this.debug("- exiting: events pool is empty",this.events_pool,"warn"),void 0;if(1>this.flush_pool)return this.debug("- ignored, flush pool is empty",this.flush_pool,"warn"),this.reset(),void 0;var i=this.generate_query_string(this.queue),s=MD5(i).substring(0,4),n=new Image(1,1);this.debug_enabled&&(n.onload=function(){window.qunit_collector&&window.qunit_collector(this)}),n.src=this.beacon_url+i+"&x="+s,this.validate_beacon(i),this.debug("- hmac "+s+" for ",i),this.debug("- beacon url ",n.src),this.last_flush_ts=Math.round((new Date).getTime()/1e3),this.flush_pool=Math.max(this.flush_pool-1,0),this.events_pool=Math.max(this.events_pool-this.queue.length,0),this.debug("- events pool after flush",this.events_pool),this.debug("- flush pool after flush",this.flush_pool),this.reset()},sanitize:function(e){for(var t=function(i,s){var n="object"==typeof s;n||(s={"":s});for(var o in s)if(s.hasOwnProperty(o)){n&&(this.sanitize_key(o)||this.log('sanitization removed invalid nested key "'+o+'" from "'+i+'". Value = "'+s[o]+'".',"","error"));var a=i+(o?"."+o:""),r=s[o];"object"==typeof r?t(a,r):e[a]=r}return n}.bind(this),i=Object.getOwnPropertyNames(e),s=0;i.length>s;++s){var n=i[s],o=this.sanitize_key(n,!0);o?t(n,e[n])?delete e[n]:""===e[n]&&delete e[n]:(this.log('sanitization removed key "'+n+'" with value = "'+e[n]+'".',"","error"),delete e[n])}return e},sanitize_key:function(t,i){var s=(t+"").toLowerCase().replace(e,"");return i&&this.reserved_regex.test(s)?!1:s!=t?!1:!0},serialize:function(e,t){for(var i=[],s=0;e.length>s;s++){var n=s>0?s+"-":"";t||(n="*-");for(var o in e[s])!e[s].hasOwnProperty(o)||t&&t.hasOwnProperty(o)&&t[o]==e[s][o]||i.push(n+encodeURIComponent(o)+"="+encodeURIComponent(e[s][o]))}return i.join("&")},generate_query_string:function(e){var t={};if(1==e.length)return this.serialize(e,t);for(var i,s={},n={},o=0;e.length>o;o++)for(i in e[o])if(e[o].hasOwnProperty(i)){var a=e[o][i];s[i]||(s[i]={},n[i]={}),s[i].hasOwnProperty(a)||(s[i][a]=0,n[i]={count:1,value:a}),s[i][a]+=1,(s[i][a]>n[i].count||n[i].count>1&&n[i].count==s[i][a]&&a.length>n[i].value.length)&&(n[i].count=s[i][a],n[i].value=a)}for(i in n)n.hasOwnProperty(i)&&n[i].count==e.length&&(t[i]=n[i].value);return this.debug("multiplexed",t),[this.serialize([t]),this.serialize(e,t)].join("&")},log:function(e,t,i){i=i||"log",window.ddt&&ddt[i]&&ddt[i]("dapx",e,t)},debug:function(){this.debug_enabled&&this.log.apply(this,arguments)},validate_beacon:function(e){try{if(!$)return;var t=e.split("&"),i={};$.each(t,function(e,t){var s=t.split("=");i[decodeURIComponent(s[0])]=decodeURIComponent(s[1])});var s={},n={};$.each(i,function(e,t){var i=e.match(/(\d+)-(.*)/);return i?(s["p"+i[1]]=s["p"+i[1]]||{},s["p"+i[1]][i[2]]=t,void 0):(i=e.match(/(\*)-(.*)/))?(n[i[2]]=t,void 0):(s.p0=s.p0||{},s.p0[e]=t,void 0)}),$.each(n,function(e,t){$.each(s,function(i,s){s[e]||(s[e]=t)})}),$.each(s,function(t,i){if(!i.t.match(/..ad$/)){var s=!1;for(var n in i)switch(n){case"slot":case"ad_campaignid":case"adfw":case"adts":s=!0}s&&ddt.alert("dapx","Got invalid beacon - ad keys in non ads",{payload:i,queue:this.queue,src:e},["dapx"],!0)}})}catch(o){ddt.alert("dapx","Beacon validate threw",{err:o.message},["dapx"],!0)}}};var s=new i;s.init()})(),window.DWait&&DWait.run("jms/thirdparty/lib/dapx/dapx.tracker.js");if(window.DWait){DWait.count()}